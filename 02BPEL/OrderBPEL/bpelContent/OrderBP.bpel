<!-- OrderBP BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Mon Nov 07 18:43:51 CET 2011 -->
<bpel:process name="OrderBP"
         targetNamespace="http://www.jboss.org/vut/bpel/order"
         suppressJoinFailure="yes"
         xmlns:tns="http://www.jboss.org/vut/bpel/order"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns1="http://www.jboss.org/vut/order" xmlns:ns2="http://www.w3.org/2001/XMLSchema">

    <!-- Import the client WSDL -->
    <bpel:import namespace="http://www.jboss.org/vut/order" location="OrderWS.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import location="OrderBPArtifacts.wsdl" namespace="http://www.jboss.org/vut/bpel/order" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
         
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <bpel:partnerLink name="Interface"
                     partnerLinkType="tns:OrderBP"
                     myRole="OrderBPProvider"
                     />
        <bpel:partnerLink name="OrderModule" partnerLinkType="tns:OrderWSLinkType" partnerRole="OrderWSRole"></bpel:partnerLink>
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
        <bpel:variable name="ReceiveCreate" messageType="tns:createOrderRequest"/>
        <bpel:variable name="ReplyCreate" messageType="tns:createOrderResponse"/>
        <bpel:variable name="CreateOrderIn" messageType="ns1:OrderWS_createOrder"></bpel:variable>
        <bpel:variable name="CreateOrderOut" messageType="ns1:OrderWS_createOrderResponse"></bpel:variable>
        <bpel:variable name="SetTechApproverIn" messageType="ns1:OrderWS_setApprover"></bpel:variable>
        <bpel:variable name="ReceiveTechDecision" messageType="tns:techDecideRequest"></bpel:variable>
        <bpel:variable name="ReplyTechDecision" messageType="tns:techDecideResponse"></bpel:variable>
        <bpel:variable name="SetOrderStateIn" messageType="ns1:OrderWS_setOrderState"></bpel:variable>
        <bpel:variable name="orderID" type="ns2:long"></bpel:variable>
        <bpel:variable name="SetFindirApproverIn" messageType="ns1:OrderWS_setApprover"></bpel:variable>
        
        <bpel:variable name="ReceiveFindirDecision" messageType="tns:findirDecideRequest"></bpel:variable>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:correlationSets>
        <bpel:correlationSet name="orderID" properties="tns:orderID"/>
    </bpel:correlationSets>
    <bpel:sequence name="main">
        
        <!-- Receive input from requester. 
             Note: This maps to operation defined in OrderBP.wsdl 
             -->
        <bpel:receive name="ReceiveCreate" partnerLink="Interface"
                 portType="tns:OrderBP"
                 operation="createOrder" variable="ReceiveCreate"
                 createInstance="yes"/>
        <bpel:assign validate="no" name="AssignOrderDetails">
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>
                        <tns:createOrder xmlns:tns="http://www.jboss.org/vut/order" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><creator>0</creator>
  <itemName>itemName</itemName>
  <itemPrice>0.0</itemPrice>
  <quantity>0</quantity>

                        </tns:createOrder>
                    </bpel:literal>
                </bpel:from>
                <bpel:to variable="CreateOrderIn" part="createOrder"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="ReceiveCreate">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[tns:creator]]>
                    </bpel:query>
                </bpel:from>
                <bpel:to part="createOrder" variable="CreateOrderIn">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[creator]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="ReceiveCreate">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:itemName]]></bpel:query>
                </bpel:from>
                <bpel:to part="createOrder" variable="CreateOrderIn">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[itemName]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="ReceiveCreate">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:itemPrice]]></bpel:query>
                </bpel:from>
                <bpel:to part="createOrder" variable="CreateOrderIn">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[itemPrice]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="ReceiveCreate">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:quantity]]></bpel:query>
                </bpel:from>
                <bpel:to part="createOrder" variable="CreateOrderIn">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[quantity]]></bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
        
        <!-- Generate reply to synchronous request -->
        <bpel:invoke name="Create" partnerLink="OrderModule" operation="createOrder" inputVariable="CreateOrderIn" outputVariable="CreateOrderOut"></bpel:invoke>
        
        <bpel:assign validate="no" name="AssignTechApprover">
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>
                        <tns:setApprover xmlns:tns="http://www.jboss.org/vut/order" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><orderId>0</orderId>
  <approverRole>tech</approverRole>

                        </tns:setApprover>
                    </bpel:literal>
                </bpel:from>
                <bpel:to variable="SetTechApproverIn" part="setApprover"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="createOrderResponse" variable="CreateOrderOut">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                </bpel:from>
                <bpel:to part="setApprover" variable="SetTechApproverIn">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[orderId]]>
                    </bpel:query>
                </bpel:to>
            </bpel:copy>
            
        </bpel:assign>
        <bpel:invoke name="SetTechApprover" partnerLink="OrderModule" operation="setApprover" portType="ns1:OrderWS" inputVariable="SetTechApproverIn"></bpel:invoke>
        <bpel:assign validate="no" name="AssignOrderID">
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>
                        <tns:CreateOrderResponce xmlns:tns="http://www.jboss.org/vut/bpel/order" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><tns:newOrderId>0</tns:newOrderId>

                        </tns:CreateOrderResponce>
                    </bpel:literal>
                </bpel:from>
                <bpel:to variable="ReplyCreate" part="payload"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="createOrderResponse" variable="CreateOrderOut">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                </bpel:from>
                <bpel:to part="payload" variable="ReplyCreate">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:newOrderId]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="createOrderResponse" variable="CreateOrderOut">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[return]]></bpel:query>
                </bpel:from>
                <bpel:to variable="orderID"></bpel:to>
            </bpel:copy>
        </bpel:assign>
        <bpel:reply name="ReplyCreate" 
               partnerLink="Interface"
               portType="tns:OrderBP"
               operation="createOrder" 
               variable="ReplyCreate"
               >
            <bpel:correlations>
                <bpel:correlation set="orderID" initiate="yes"></bpel:correlation>
            </bpel:correlations>
        </bpel:reply>
        <bpel:receive name="ReceiveTechDecision" partnerLink="Interface" operation="techDecide" portType="tns:OrderBP" variable="ReceiveTechDecision">
            <bpel:correlations>
                <bpel:correlation set="orderID" initiate="no"></bpel:correlation>
            </bpel:correlations>
        </bpel:receive>
        <bpel:assign validate="no" name="AssignReturnValue">
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>
                        <tns:TechDecideResponse xmlns:tns="http://www.jboss.org/vut/bpel/order" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><tns:success>true</tns:success>

                        </tns:TechDecideResponse>
                    </bpel:literal>
                </bpel:from>
                <bpel:to variable="ReplyTechDecision" part="payload"></bpel:to>
            </bpel:copy>
            
        </bpel:assign>
        <bpel:reply name="ReplyTechDecision" partnerLink="Interface" operation="techDecide" portType="tns:OrderBP" variable="ReplyTechDecision"></bpel:reply>
        <bpel:if name="TechDecision">
            <bpel:condition><![CDATA[$ReceiveTechDecision.payload/tns:type = 'approved']]></bpel:condition>
            <bpel:if name="OrderPrice">
                <bpel:condition><![CDATA[($CreateOrderIn.createOrder/itemPrice * $CreateOrderIn.createOrder/quantity) < 40000 ]]></bpel:condition>
                <bpel:sequence>
                    
                    
                    <bpel:empty name="Empty"></bpel:empty>
                </bpel:sequence>
                <bpel:else>
                    <bpel:sequence>
                    
                    
                        
                        
                        <bpel:empty name="Empty"></bpel:empty>
                    </bpel:sequence>
                </bpel:else>
            </bpel:if>
            <bpel:else>
                <bpel:sequence>
                    <bpel:assign validate="no" name="AssignDeclined">
                        <bpel:copy>
                            <bpel:from>
                                <bpel:literal>
                                    <tns:setOrderState xmlns:tns="http://www.jboss.org/vut/order" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><orderId>0</orderId>
  <newState>DECLINED</newState>

                                    </tns:setOrderState>
                                </bpel:literal>
                            </bpel:from>
                            <bpel:to variable="SetOrderStateIn" part="setOrderState"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from variable="orderID"></bpel:from>
                            <bpel:to part="setOrderState" variable="SetOrderStateIn">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[orderId]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="SetFinalOrderState" partnerLink="OrderModule" operation="setOrderState" portType="ns1:OrderWS" inputVariable="SetOrderStateIn"></bpel:invoke>
                </bpel:sequence>
            </bpel:else>
        </bpel:if>
    </bpel:sequence>
</bpel:process>

